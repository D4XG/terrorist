{"version":3,"sources":["document.js"],"names":["assert","require","browserFeatures","Fetch","DOM","EventSource","iconv","QS","resourceLoader","Resources","URL","Utils","VM","WebSocket","Window","XMLHttpRequest","idlUtils","File","Screen","constructor","top","left","width","height","availLeft","availTop","availWidth","availHeight","colorDepth","pixelDepth","DOMURL","url","base","TypeError","resolve","parsed","parse","origin","protocol","hostname","hash","value","enumerable","host","href","format","password","pathname","port","search","username","toString","setupWindow","window","args","document","browser","history","parent","opener","closed","onerror","message","filename","lineno","colno","error","_eventQueue","enqueue","emit","Object","defineProperty","name","_globalProxy","_parent","_top","console","resources","emptySet","item","undefined","namedItem","writable","appName","appVersion","VERSION","cookieEnabled","javaEnabled","language","mimeTypes","noUI","platform","process","plugins","userAgent","vendor","get","cookies","serialize","location","_storages","extend","Event","MouseEvent","MutationEvent","UIEvent","screen","Function","fetch","_fetch","bind","Request","Response","FormData","atob","string","Buffer","btoa","_allWebSockets","ws","origProperty","prototype","call","set","type","push","Image","img","createElement","DataView","resizeTo","outerWidth","innerWidth","outerHeight","innerHeight","resizeBy","onhashchange","_evaluate","code","context","createContext","originalInScope","_windowInScope","result","String","runInContext","eventQueue","_eventLoop","createEventQueue","setTimeout","clearTimeout","setInterval","clearInterval","setImmediate","fn","clearImmediate","requestAnimationFrame","cancelAnimationFrame","eventSource","addEventSource","alert","handled","log","confirm","question","event","response","prompt","open","tabs","_destroy","removeAllListeners","close","i","_length","destroy","_closed","windowHistory","forward","go","back","amount","pushState","stateArgs","replaceState","dump","output","length","state","_history","assign","_submit","formArgs","target","targetWindow","modified","submit","postMessage","data","source","eventOrigin","createEvent","initMessageEvent","dispatchEvent","_document","hasFocus","current","windowLoaded","removeEventListener","windowContentLoaded","initEvent","addEventListener","Document","__defineSetter__","defaultView","createDocument","features","FetchExternalResources","ProcessExternalResources","MutationEvents","parsingMode","contentType","referrer","documentImpl","implForWrapper","hasFeature","_runScripts","applyDocumentFeatures","getMetaRefresh","refresh","querySelector","content","getAttribute","match","refreshTimeout","parseInt","refreshURL","MATCH_CHARSET","getHTMLFromResponseBody","buffer","mimeType","typeOptions","split","typeOption","test","charset","decode","charsetInMetaTag","buildRequest","method","params","site","headers","Headers","referer","has","uri","values","query","encoding","toLowerCase","urlEncoded","map","escape","join","body","form","append","parseResponse","_request","request","_response","updateLocation","_url","done","waitForCompletion","_consume","then","html","write","status","Error","documentElement","replace","newWindow","_redirectCount","catch","module","exports","loadDocument","visit","reload","slice","http"],"mappings":"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","file":"document.js","sourcesContent":["// Exports a function for creating/loading new documents.\n\nconst assert          = require('assert');\nconst browserFeatures = require('jsdom/lib/jsdom/browser/documentfeatures');\nconst Fetch           = require('./fetch');\nconst DOM             = require('./dom');\nconst EventSource     = require('eventsource');\nconst iconv           = require('iconv-lite');\nconst QS              = require('querystring');\nconst resourceLoader  = require('jsdom/lib/jsdom/browser/resource-loader');\nconst Resources       = require('./resources');\nconst URL             = require('url');\nconst Utils           = require('jsdom/lib/jsdom/utils');\nconst VM              = require('vm');\nconst WebSocket       = require('ws');\nconst Window          = require('jsdom/lib/jsdom/browser/Window');\nconst XMLHttpRequest  = require('./xhr');\nconst { idlUtils }    = require('./dom/impl');\n\n// File access, not implemented yet\nclass File {\n}\n\n\n// Screen object provides access to screen dimensions\nclass Screen {\n  constructor() {\n    this.top = this.left = 0;\n    this.width = 1280;\n    this.height = 800;\n  }\n\n  get availLeft() {\n    return 0;\n  }\n  get availTop() {\n    return 0;\n  }\n  get availWidth() {\n    return 1280;\n  }\n  get availHeight() {\n    return 800;\n  }\n  get colorDepth() {\n    return 24;\n  }\n  get pixelDepth() {\n    return 24;\n  }\n}\n\n\n// DOM implementation of URL class\nclass DOMURL {\n\n  constructor(url, base) {\n    if (url == null)\n       throw new TypeError('Failed to construct \\'URL\\': Invalid URL');\n    if (base)\n      url = URL.resolve(base, url);\n    const parsed = URL.parse(url || 'about:blank');\n    const origin = parsed.protocol && parsed.hostname && `${parsed.protocol}//${parsed.hostname}`;\n    Object.defineProperties(this, {\n      hash:     { value: parsed.hash,         enumerable: true },\n      host:     { value: parsed.host,         enumerable: true },\n      hostname: { value: parsed.hostname,     enumerable: true },\n      href:     { value: URL.format(parsed),  enumerable: true },\n      origin:   { value: origin,              enumerable: true },\n      password: { value: parsed.password,     enumerable: true },\n      pathname: { value: parsed.pathname,     enumerable: true },\n      port:     { value: parsed.port,         enumerable: true },\n      protocol: { value: parsed.protocol,     enumerable: true  },\n      search:   { value: parsed.search,       enumerable: true },\n      username: { value: parsed.username,     enumerable: true }\n    });\n  }\n\n  toString() {\n    return this.href;\n  }\n\n}\n\n\nfunction setupWindow(window, args) {\n  const { document }          = window;\n  const { browser, history }  = args;\n  const { parent, opener }    = args;\n\n  let   closed        = false;\n\n  // Catch all errors\n  window.onerror = ((message, filename, lineno, colno, error) => {\n    window._eventQueue.enqueue(() => browser.emit('error', error));\n  });\n\n  // Access to browser\n  Object.defineProperty(window, 'browser', {\n    value:      browser,\n    enumerable: true\n  });\n\n  window.name     = args.name || '';\n\n  // If this was opened from another window\n  window.opener   = opener && opener._globalProxy;\n  // Frames provide their own parent reference\n  window._parent  = (parent || window);\n  window._top     = (parent || window).top;\n\n  window.console = browser.console;\n\n  // All the resources loaded by this window.\n  window.resources = new Resources(window);\n\n  // javaEnabled, present in browsers, not in spec Used by Google Analytics see\n  /// https://developer.mozilla.org/en/DOM/window.navigator.javaEnabled\n  const emptySet = [];\n  emptySet.item = ()=> undefined;\n  emptySet.namedItem = ()=> undefined;\n  Object.defineProperty(window, 'navigator', {\n    writable: false,\n    value: {\n      appName:        'Zombie',\n      appVersion:     browser.constructor.VERSION,\n      cookieEnabled:  true,\n      javaEnabled:    ()=> false,\n      language:       browser.language,\n      mimeTypes:      emptySet,\n      noUI:           true,\n      platform:       process.platform,\n      plugins:        emptySet,\n      userAgent:      browser.userAgent,\n      vendor:         'Zombie Industries'\n    }\n  });\n\n  // Add cookies, storage, alerts/confirm, XHR, WebSockets, JSON, Screen, etc\n  Object.defineProperty(window, 'cookies', {\n    get() {\n      return browser.cookies.serialize(this.location.hostname, this.location.pathname);\n    }\n  });\n  browser._storages.extend(window);\n\n  window.File =           File;\n  window.Event =          DOM.Event;\n  window.MouseEvent =     DOM.MouseEvent;\n  window.MutationEvent =  DOM.MutationEvent;\n  window.UIEvent =        DOM.UIEvent;\n  const screen =         new Screen();\n  Object.defineProperty(window, 'screen',{\n    get(){\n      return screen;\n    }\n  });\n\n  // for inline event handlers\n  window._globalProxy.Function = Function;\n\n  // Fetch API\n  window.fetch =          window.resources._fetch.bind(window.resources);\n  window.Request =        Fetch.Request;\n  window.Response =       Fetch.Response;\n  window.FormData =       Fetch.FormData;\n\n  // Base-64 encoding/decoding\n  window.atob = (string)=> new Buffer(string, 'base64').toString('binary');\n  window.btoa = (string)=> new Buffer(string, 'binary').toString('base64');\n\n  // Constructor for XHLHttpRequest\n  window.XMLHttpRequest = XMLHttpRequest.bind(null, window);\n  window.URL = DOMURL;\n\n  // Web sockets\n  window._allWebSockets = [];\n\n  window.WebSocket = function(url, protocol) {\n    url = URL.resolve(document.URL, url);\n    const origin = `${window.location.protocol}//${window.location.host}`;\n    const ws = new WebSocket(url, { origin, protocol });\n\n    // The < 1.x implementations of ws used to allows 'buffer' to be defined\n    // as the binary type in node environments. Now, the supported type is\n    // 'nodebuffer'. Version of engine.io-client <= 1.6.12 use the 'buffer'\n    // type and this is a shim to allow that to keep working unti that version\n    // of engine.io-client does not need to be supported anymore\n    const origProperty = Object.getOwnPropertyDescriptor(WebSocket.prototype, 'binaryType');\n    Object.defineProperty(ws, 'binaryType', {\n      get: function get() {\n        return origProperty.get.call(this);\n      },\n      set: function set(type) {\n        if (type === 'buffer')\n          type = 'nodebuffer';\n        return origProperty.set.call(this, type);\n      }\n    });\n    window._allWebSockets.push(ws);\n    return ws;\n  };\n\n  window.Image = function(width, height) {\n    const img   = window.document.createElement('img');\n    img.width   = width;\n    img.height  = height;\n    return img;\n  };\n\n  // DataView: get from globals\n  window.DataView = DataView;\n\n  window.resizeTo = function(width, height) {\n    window.outerWidth   = window.innerWidth   = width;\n    window.outerHeight  = window.innerHeight  = height;\n  };\n  window.resizeBy = function(width, height) {\n    window.resizeTo(window.outerWidth + width,  window.outerHeight + height);\n  };\n\n  // Some libraries (e.g. Backbone) check that this property exists before\n  // deciding to use onhashchange, so we need to set it to null.\n  window.onhashchange = null;\n\n\n\n  // -- JavaScript evaluation\n\n  // Evaluate in context of window. This can be called with a script (String) or a function.\n  window._evaluate = function(code, filename) {\n    const context = new VM.createContext(window);\n    const originalInScope = browser._windowInScope;\n    try {\n      // The current window, postMessage and window.close need this\n      browser._windowInScope = window;\n      let result;\n      if (typeof code == 'buffer' || code instanceof Buffer)\n        code = code.toString();\n      if (typeof code === 'string' || code instanceof String)\n        result = VM.runInContext(code, context, { filename });\n      else if (code)\n        result = code.call(window);\n      browser.emit('evaluated', code, result, filename);\n      return result;\n    } catch (error) {\n      if (error && typeof error === 'object') \n        error.filename = error.filename || filename;\n      throw error;\n    } finally {\n      browser._windowInScope = originalInScope;\n    }\n  };\n\n\n  // -- Event loop --\n\n  const eventQueue = browser._eventLoop.createEventQueue(window);\n  Object.defineProperty(window, '_eventQueue', {\n    value: eventQueue\n  });\n  window.setTimeout     = eventQueue.setTimeout.bind(eventQueue);\n  window.clearTimeout   = eventQueue.clearTimeout.bind(eventQueue);\n  window.setInterval    = eventQueue.setInterval.bind(eventQueue);\n  window.clearInterval  = eventQueue.clearInterval.bind(eventQueue);\n  window.setImmediate   = (fn)=> eventQueue.setTimeout(fn, 0);\n  window.clearImmediate = eventQueue.clearTimeout.bind(eventQueue);\n  window.requestAnimationFrame  = window.setImmediate;\n  window.cancelAnimationFrame   = window.clearImmediate;\n\n\n  // Constructor for EventSource, URL is relative to document's.\n  window.EventSource = function(url) {\n    url = URL.resolve(document.URL, url);\n    const eventSource = new EventSource(url);\n    eventQueue.addEventSource(eventSource);\n    return eventSource;\n  };\n\n\n  // -- Interaction --\n\n  window.alert = function(message) {\n    const handled = browser.emit('alert', message);\n    if (!handled)\n      browser.log('Unhandled window.alert(\"%s\")');\n    browser.log('alert(\"%s\")', message);\n  };\n\n  window.confirm = function(question) {\n    const event     = { question, response: true };\n    const handled   = browser.emit('confirm', event);\n    if (!handled)\n      browser.log('Unhandled window.confirm(\"%s\")');\n    const response  = !!event.response;\n    browser.log('confirm(\"%s\") -> %ss', question, response);\n    return response;\n  };\n\n  window.prompt = function(question, value) {\n    const event     = { question, response: value || '' };\n    const handled   = browser.emit('prompt', event);\n    if (!handled)\n      browser.log('Unhandled window.prompt(\"%s\")');\n    const response  = (event.response || '').toString();\n    browser.log('prompt(\"..\") -> \"%s\"', question, response);\n    return response;\n  };\n\n\n  // -- Opening and closing --\n\n  // Open one window from another.\n  window.open = function(url, name) {\n    url = (url !== null) ? URL.resolve(document.URL, url || '') : null;\n    return browser.tabs.open({ name: name, url: url, opener: window });\n  };\n\n  // Indicates if window was closed\n  Object.defineProperty(window, 'closed', {\n    get() { return closed; },\n    enumerable: true\n  });\n\n  // Used by window.close() and also from history.destroy/replace/etc\n  // global.\n  window._destroy = function() {\n    // We call history.destroy which calls destroy on all windows, so need to\n    // avoid infinite loop.\n    if (closed)\n      return;\n    closed = true;\n\n    for (const ws of window._allWebSockets) {\n      ws.removeAllListeners();\n      ws.close();\n    }\n\n    // Close all frames first\n    for (let i = 0; i < window._length; ++i)\n      if (window[i])\n        window[i].close();\n    // kill event queue, document and window.\n    eventQueue.destroy();\n    document.close();\n  };\n\n  // window.close actually closes the tab, and disposes of all windows in the history.\n  // Also used to close iframe.\n  window.close = function() {\n    if (parent || closed)\n      return;\n\n    // Only opener window can close window; any code that's not running from\n    // within a window's context can also close window.\n    if (browser._windowInScope === opener || browser._windowInScope === null) {\n      browser.tabs._closed(window);\n      // Only parent window gets the close event\n      browser.emit('closed', window);\n      history.destroy(); // do this last to prevent infinite loop\n    } else\n      browser.log('Scripts may not close windows that were not opened by script');\n  };\n\n\n  // -- Navigating --\n\n  // Each window maintains its own view of history\n  const windowHistory = {\n    forward() {\n      windowHistory.go(1);\n    },\n    back() {\n      windowHistory.go(-1);\n    },\n    go(amount) {\n      history.go(amount);\n    },\n    pushState(...stateArgs) {\n      history.pushState(...stateArgs);\n    },\n    replaceState(...stateArgs) {\n      history.replaceState(...stateArgs);\n    },\n    dump(output) {\n      history.dump(output);\n    }\n  };\n  Object.defineProperties(windowHistory, {\n    length: {\n      get() { return history.length; },\n      enumerable: true\n    },\n    state: {\n      get() { return history.state; },\n      enumerable: true\n    }\n  });\n\n  // DOM History object\n  Object.defineProperty(window, 'history', {\n    writable: false,\n    value: windowHistory\n  });\n  /// Actual history, see location getter/setter\n  window._history = history;\n\n  // Read/write access to window.location\n  Object.defineProperty(window, 'location', {\n    get() {\n      return document.location;\n    },\n    set(url) {\n      history.assign(url);\n    }\n  });\n\n\n  // Form submission uses this\n  window._submit = function(formArgs) {\n    const url     = URL.resolve(document.URL, formArgs.url);\n    const target  = formArgs.target || '_self';\n    browser.emit('submit', url, target);\n    // Figure out which history is going to handle this\n    const targetWindow =\n      (target === '_self')   ? window :\n      (target === '_parent') ? window.parent :\n      (target === '_top')    ? window.top :\n      browser.tabs.open({ name: target });\n    const modified = Object.assign({}, formArgs, { url, target });\n    targetWindow._history.submit(modified);\n  };\n\n  // Overload jsdom postMessage function, which is added to the window object\n  // when created jsdom/lib/jsdom/browser/Window.js.\n  // This is needed because jsdom's implementation does not define the source\n  // and origin attributes in the issued events.\n  // This implementation should be dropped in favor of\n  // jsdom/lib/jsdom/living/post-message.js when it supports source and origin.\n  window.postMessage = function(data) {\n    // Window A (source) calls B.postMessage, to determine A we need the\n    // caller's window.\n\n    // DDOPSON-2012-11-09 - _windowInScope.getGlobal() is used here so that for\n    // website code executing inside the sandbox context, event.source ==\n    // window. Even though the _windowInScope object is mapped to the sandboxed\n    // version of the object returned by getGlobal, they are not the same object\n    // ie, _windowInScope.foo == _windowInScope.getGlobal().foo, but\n    // _windowInScope != _windowInScope.getGlobal()\n    const source = (this.browser._windowInScope || this);\n\n    const origin = source.location;\n    const eventOrigin = URL.format({ protocol: origin.protocol, host: origin.host });\n\n    const event = this.document.createEvent('MessageEvent');\n    event.initMessageEvent('message', false, false, data, eventOrigin, null, source, []);\n\n    this.dispatchEvent(event);\n  };\n\n  // Inject HTMLDocument.hasFocus function\n  // https://developer.mozilla.org/en-US/docs/Web/API/Document/hasFocus\n  window._document.hasFocus = function() {\n    return browser.tabs.current.document === this;\n  };\n\n  // JSDOM fires DCL event on document but not on window\n  function windowLoaded(event) {\n    document.removeEventListener('DOMContentLoaded', windowLoaded);\n\n    // JSDom > 7.1 does not allow re-dispatching the same event, so\n    // a copy of the event needs to be created for the new dispatch\n    const windowContentLoaded = document.createEvent('HTMLEvents');\n    windowContentLoaded.initEvent('DOMContentLoaded', false, false);\n    window.dispatchEvent(windowContentLoaded);\n  }\n  document.addEventListener('DOMContentLoaded', windowLoaded);\n\n  // Window is now open, next load the document.\n  browser.emit('opened', window);\n}\n\n\n// Change location\nDOM.Document.prototype.__defineSetter__('location', function(url) {\n  this.defaultView.location = url;\n});\n\n\n// Creates an returns a new document attached to the window.\nfunction createDocument(args) {\n  const { browser } = args;\n\n  const features = {\n    FetchExternalResources:   [],\n    ProcessExternalResources: [],\n    MutationEvents:           '2.0'\n  };\n\n  const window  = new Window({\n    parsingMode:  'html',\n    contentType:  'text/html',\n    url:          args.url,\n    referrer:     args.referrer\n  });\n\n  const { document } = window;\n  const documentImpl = idlUtils.implForWrapper(document)\n\n  if (args.browser.hasFeature('scripts', true)) {\n    features.FetchExternalResources.push('script');\n    features.ProcessExternalResources.push('script');\n    window._runScripts = 'dangerously';\n  }\n  if (args.browser.hasFeature('css', false)) {\n    features.FetchExternalResources.push('css');\n    features.FetchExternalResources.push('link');\n  }\n  if (args.browser.hasFeature('img', false))\n    features.FetchExternalResources.push('img');\n  if (args.browser.hasFeature('iframe', true))\n    features.FetchExternalResources.push('iframe');\n\n\n  browserFeatures.applyDocumentFeatures(documentImpl, features);\n  setupWindow(window, args);\n\n  // Give event handler chance to register listeners.\n  args.browser.emit('loading', document);\n  return document;\n}\n\n\n// Get refresh URL and timeout from <meta> tag\nfunction getMetaRefresh(document) {\n  const refresh = document.querySelector('meta[http-equiv=\"refresh\"]');\n  if (refresh) {\n    const content = refresh.getAttribute('content');\n    const match   = content.match(/^\\s*(\\d+)(?:\\s*;\\s*url\\s*=\\s*(.*?))?\\s*(?:;|$)/i);\n    if (match) {\n      const refreshTimeout = parseInt(match[1], 10);\n      const refreshURL     = match[2] || document.location.href;\n      if (refreshTimeout >= 0)\n        return { refreshTimeout, refreshURL };\n    }\n  }\n  return null;\n}\n\n\n// Find the charset= value of the meta tag\nconst MATCH_CHARSET = /<meta(?!\\s*(?:name|value)\\s*=)[^>]*?charset\\s*=[\\s\"']*([^\\s\"'\\/>]*)/i;\n\n// Extract HTML from response with the proper encoding:\n// - If content type header indicates charset use that\n// - Otherwise, look for <meta> tag with charset in body\n// - Otherwise, browsers default to windows-1252 encoding\nfunction getHTMLFromResponseBody(buffer, contentType) {\n  const [mimeType, ...typeOptions]  = contentType.split(/;\\s*/);\n\n  // Pick charset from content type\n  if (mimeType)\n    for (let typeOption of typeOptions)\n      if (/^charset=/i.test(typeOption)) {\n        const charset = typeOption.split('=')[1];\n        return iconv.decode(buffer, charset);\n      }\n\n  // Otherwise, HTML documents only, pick charset from meta tag\n  // Otherwise, HTML documents only, default charset in US is windows-1252\n  const charsetInMetaTag = buffer.toString().match(MATCH_CHARSET);\n  if (charsetInMetaTag)\n    return iconv.decode(buffer, charsetInMetaTag[1]);\n  else\n    return iconv.decode(buffer, 'windows-1252');\n}\n\n\n// Builds and returns a new Request, adding form parameters to URL (GET) or\n// request body (POST).\nfunction buildRequest(args) {\n  const { browser, method } = args;\n  const params  = args.params || new Map();\n  const site    = /^(https?:|file:)/i.test(browser.site) ? browser.site : `http://${browser.site || 'locahost'}`;\n  const url     = URL.resolve(site, URL.format(args.url));\n\n  const headers = new Fetch.Headers(args.headers);\n\n  // HTTP header Referer, but Document property referrer\n  const referrer = args.referrer || browser.referrer || browser.referer || args.history.url;\n  if (referrer && !headers.has('Referer'))\n    headers.set('Referer', referrer);\n  if (!headers.has('Accept'))\n    headers.set('Accept', 'text/html,*/*');\n\n  if (/^GET|HEAD|DELETE$/i.test(method)) {\n    const uri = URL.parse(url, true);\n    // These methods use query string parameters instead\n    for (let [name, values] of params)\n      uri.query[name] = values;\n    return new Fetch.Request(URL.format(uri), { method, headers });\n  }\n\n  const mimeType = (args.encoding || '').split(';')[0].toLowerCase();\n  // Default mime type, but can also be specified in form encoding\n  if (mimeType === '' || mimeType === 'application/x-www-form-urlencoded') {\n    const urlEncoded = [...params]\n      .map(function([name, values]) {\n        return values.map(value => `${QS.escape(name)}=${QS.escape(value)}`).join('&');\n      })\n      .join('&');\n\n    headers.set('Content-Type', 'application/x-www-form-urlencoded;charset=UTF-8');\n    return new Fetch.Request(url, { method, headers, body: urlEncoded });\n  }\n\n  if (mimeType === 'multipart/form-data') {\n    const form = new Fetch.FormData();\n    for (let [name, values] of params)\n      for (let value of values)\n        form.append(name, value);\n    return new Fetch.Request(url, { method, headers, body: form });\n  }\n\n  throw new TypeError(`Unsupported content type ${mimeType}`);\n}\n\n\n// Parse HTML response and setup document\nfunction parseResponse({ browser, history, document, response }) {\n  const window      = document.defaultView;\n  window._request   = response.request;\n  window._response  = response;\n  history.updateLocation(window, response._url);\n\n  const done = window._eventQueue.waitForCompletion();\n  response\n    ._consume()\n    .then(function(body) {\n\n      const contentType = response.headers.get('Content-Type') || '';\n      const html        = getHTMLFromResponseBody(body, contentType);\n      response.body     = html;\n      document.write(html || '<html></html>');\n      document.close();\n\n      browser.emit('loaded', document);\n      if (response.status >= 400)\n        throw new Error(`Server returned status code ${response.status} from ${response.url}`);\n      if (!document.documentElement)\n        throw new Error(`Could not parse document at ${response.url}`);\n\n    })\n    .then(function() {\n\n      // Handle meta refresh.  Automatically reloads new location and counts\n      // as a redirect.\n      //\n      // If you need to check the page before refresh takes place, use this:\n      //   browser.wait({\n      //     function: function() {\n      //       return browser.query('meta[http-equiv=\"refresh\"]');\n      //     }\n      //   });\n      const refresh = getMetaRefresh(document);\n\n      if (refresh) {\n        const { refreshTimeout } = refresh;\n        const { refreshURL }     = refresh;\n\n        window._eventQueue.setTimeout(function() {\n          // Allow completion function to run\n          window._eventQueue.enqueue(function() {\n            window._eventQueue.enqueue(function() {\n              // Count a meta-refresh in the redirects count.\n              history.replace(refreshURL);\n              // This results in a new window getting loaded\n              const newWindow = history.current.window;\n              newWindow.addEventListener('load', function() {\n                ++newWindow._request._redirectCount;\n              });\n            });\n          });\n        }, refreshTimeout * 1000);\n      }\n\n    })\n    .catch(function(error) {\n      browser.emit('error', error);\n    })\n    .then(done);\n}\n\n\n// Load/create a new document.\n//\n// Named arguments:\n// browser   - The browser (required)\n// history   - Window history (required)\n// url       - URL of document to open (defaults to \"about:blank\")\n// method    - HTTP method (defaults to \"GET\")\n// encoding  - Request content type (forms use this)\n// params    - Additional request parameters (Map)\n// html      - Create document with this content instead of loading from URL\n// name      - Window name\n// referrer  - HTTP referer header\n// parent    - Parent document (for frames)\n// opener    - Opening window (for window.open)\n// target    - Target window name (for form.submit)\n//\n// Returns a new document with a new window.  The document contents is loaded\n// asynchronously, and will trigger a loaded/error event.\nmodule.exports = function loadDocument(args) {\n  const { browser, history, url, html } = args;\n  assert(browser && browser.visit, 'Missing parameter browser');\n  assert(history && history.reload, 'Missing parameter history');\n\n  const document = createDocument(Object.assign({ url }, args));\n  const window   = document.defaultView;\n\n  const content = (url =='about:blank') ?\n    '<html><head></head><body></body></html>' : html;\n\n  if (content) {\n    window._eventQueue.enqueue(function() {\n      document.write(content);\n      document.close();\n      browser.emit('loaded', document);\n    });\n    return document;\n  }\n\n  // Let's handle the specifics of each protocol\n  if (!url || /^about:/.test(url)) {\n    window._eventQueue.enqueue(function() {\n      document.close();\n      browser.emit('loaded', document);\n    });\n    return document;\n  }\n\n  if (/^javascript:/.test(url)) {\n    window._eventQueue.enqueue(function() {\n      document.close();\n      try {\n        window._evaluate(url.slice(11), 'javascript:');\n        browser.emit('loaded', document);\n      } catch (error) {\n        browser.emit('error', error);\n      }\n    });\n    return document;\n  }\n\n  const request = buildRequest(args);\n  window._eventQueue.http(request, (error, response)=> {\n    if (error) {\n      document.write(`<html><body>${error.message}</body></html>`);\n      document.close();\n      browser.emit('error', error);\n    } else\n      parseResponse({ browser, history, document, response });\n\n  });\n  return document;\n};\n"]}