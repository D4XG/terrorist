{"version":3,"sources":["dom/jsdom_patches.js"],"names":["DOM","require","Fetch","resourceLoader","Utils","URL","idlUtils","HTMLElementImpl","HTMLAnchorElementImpl","HTMLImageElementImpl","implementation","prototype","_activationBehavior","window","ownerDocument","defaultView","browser","target","wrapperForImpl","location","href","parent","top","tabs","open","name","url","emit","_attrModified","value","oldVal","load","call","HTMLElement","getClientRects","style","display","bottom","height","left","right","width","Object","defineProperty","get","insertAdjacentHTML","position","html","parentNode","container","createElementNS","innerHTML","toLowerCase","firstChild","insertBefore","lastChild","appendChild","nextSibling","Node","contains","otherNode","compareDocumentPosition","CSSStyleDeclaration","opacity","getPropertyValue","toString","set","undefined","removeProperty","parseFloat","isFinite","_setProperty","jsdomDispatchEvent","EventTarget","dispatchEvent","event","eventImpl","implForWrapper","document","_ownerDocument","originalInScope","_windowInScope","element","encoding","callback","tagName","loadResource","_hasFeature","resolve","enqueued","enqueue","bind","request","Request","_eventQueue","http","error","response","Error","status","_consume","then","buffer","body"],"mappings":"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","file":"jsdom_patches.js","sourcesContent":["// Fix things that JSDOM doesn't do quite right.\n\n\nconst DOM                  = require('./index');\nconst Fetch                = require('../fetch');\nconst resourceLoader       = require('jsdom/lib/jsdom/browser/resource-loader');\nconst Utils                = require('jsdom/lib/jsdom/utils');\nconst URL                  = require('url');\nconst {\n  idlUtils,\n  HTMLElementImpl,\n  HTMLAnchorElementImpl,\n  HTMLImageElementImpl\n}                          = require('./impl');\n\nHTMLAnchorElementImpl.implementation.prototype._activationBehavior = function(){\n  const window      = this.ownerDocument.defaultView;\n  const { browser } = window;\n  const target = idlUtils.wrapperForImpl(this).target || '_self';\n\n  // Decide which window to open this link in\n  switch (target) {\n    case '_self': {   // navigate same window\n      window.location = this.href;\n      break;\n    }\n    case '_parent': { // navigate parent window\n      window.parent.location = this.href;\n      break;\n    }\n    case '_top': {    // navigate top window\n      window.top.location = this.href;\n      break;\n    }\n    default: { // open named window\n      browser.tabs.open({ name: target, url: this.href });\n      break;\n    }\n  }\n  browser.emit('link', this.href, target);\n};\n\n\n// Attempt to load the image, this will trigger a 'load' event when succesful\n// jsdom seemed to only queue the 'load' event\n// DOM.HTMLImageElement.prototype._attrModified = function(name, value, oldVal) {\nHTMLImageElementImpl.implementation.prototype._attrModified = function(name, value, oldVal) {\n  if (name === 'src' && value && value !== oldVal)\n    resourceLoader.load(this, value);\n  HTMLElementImpl.implementation.prototype._attrModified.call(this, name, value, oldVal);\n};\n\n// Implement getClientRects\nDOM.HTMLElement.prototype.getClientRects = function () {\n  const style = this.style;\n\n  if (style && style.display === 'none')\n    return [];\n\n  return [{\n    bottom: 0,\n    height: 0,\n    left: 0,\n    right: 0,\n    top: 0,\n    width: 0\n  }];\n};\n\nObject.defineProperty(DOM.HTMLElement.prototype, 'offsetHeight', {\n  get: function () {\n    return 0;\n  }\n});\n\nObject.defineProperty(DOM.HTMLElement.prototype, 'offsetWidth', {\n  get: function () {\n    return 0;\n  }\n});\n\n\n// Implement insertAdjacentHTML\nDOM.HTMLElement.prototype.insertAdjacentHTML = function(position, html) {\n  const { parentNode }  = this;\n  const container       = this.ownerDocument.createElementNS('http://www.w3.org/1999/xhtml', '_');\n  container.innerHTML   = html;\n\n  switch (position.toLowerCase()) {\n    case 'beforebegin': {\n      while (container.firstChild)\n        parentNode.insertBefore(container.firstChild, this);\n      break;\n    }\n    case 'afterbegin': {\n      let firstChild = this.firstChild;\n      while (container.lastChild)\n        firstChild = this.insertBefore(container.lastChild, firstChild);\n      break;\n    }\n    case 'beforeend': {\n      while (container.firstChild)\n        this.appendChild(container.firstChild);\n      break;\n    }\n    case 'afterend': {\n      let nextSibling = this.nextSibling;\n      while (container.lastChild)\n        nextSibling = parentNode.insertBefore(container.lastChild, nextSibling);\n      break;\n    }\n  }\n};\n\n\n// Implement documentElement.contains\n// e.g., if(document.body.contains(el)) { ... }\n// See https://developer.mozilla.org/en-US/docs/DOM/Node.contains\nDOM.Node.prototype.contains = function(otherNode) {\n  // DDOPSON-2012-08-16 -- This implementation is stolen from Sizzle's\n  // implementation of 'contains' (around line 1402).\n  // We actually can't call Sizzle.contains directly:\n  // * Because we define Node.contains, Sizzle will configure it's own\n  //   \"contains\" method to call us. (it thinks we are a native browser\n  //   implementation of \"contains\")\n  // * Thus, if we called Sizzle.contains, it would form an infinite loop.\n  //   Instead we use Sizzle's fallback implementation of \"contains\" based on\n  //   \"compareDocumentPosition\".\n  return !!(this.compareDocumentPosition(otherNode) & 16);\n};\n\n\n// Support for opacity style property.\nObject.defineProperty(DOM.CSSStyleDeclaration.prototype, 'opacity', {\n  get() {\n    const opacity = this.getPropertyValue('opacity');\n    return Number.isFinite(opacity) ? opacity.toString() : '';\n  },\n\n  set(opacity) {\n    if (opacity === null || opacity === undefined || opacity === '')\n      this.removeProperty('opacity');\n    else {\n      const value = parseFloat(opacity);\n      if (isFinite(value))\n        this._setProperty('opacity', value);\n    }\n  }\n});\n\n\n// Wrap dispatchEvent to support _windowInScope and error handling.\nconst jsdomDispatchEvent = DOM.EventTarget.prototype.dispatchEvent;\nDOM.EventTarget.prototype.dispatchEvent = function(event) {\n  // Could be node, window or document\n  const eventImpl = idlUtils.implForWrapper(this);\n  const document = eventImpl._ownerDocument || this.document || this;\n\n  const window   = document.defaultView;\n  // Fail miserably on objects that don't have ownerDocument: nodes and XHR\n  // request have those\n  const { browser } = window;\n  browser.emit('event', event, this);\n\n  const originalInScope = browser._windowInScope;\n  try {\n    // The current window, postMessage and window.close need this\n    browser._windowInScope = window;\n    // Inline event handlers rely on window.event\n    window.event = event;\n    return jsdomDispatchEvent.call(this, event);\n  } finally {\n    delete window.event;\n    browser._windowInScope = originalInScope;\n  }\n};\n\n\n// Fix resource loading to keep track of in-progress requests. Need this to wait\n// for all resources (mainly JavaScript) to complete loading before terminating\n// browser.wait.\nresourceLoader.load = function(element, href, encoding, callback) {\n  const document      = element.ownerDocument;\n  const window        = document.defaultView;\n  const tagName       = element.tagName.toLowerCase();\n  const loadResource  = document.implementation._hasFeature('FetchExternalResources', tagName);\n  const url           = URL.resolve(document.URL, href);\n\n  if (loadResource) {\n    // This guarantees that all scripts are executed in order, must add to the\n    // JSDOM queue before we add to the Zombie event queue.\n    const enqueued = this.enqueue(element, url, callback && callback.bind(element));\n    const request = new Fetch.Request(url);\n    window._eventQueue.http(request, (error, response)=> {\n      // Since this is used by resourceLoader that doesn't check the response,\n      // we're responsible to turn anything other than 2xx/3xx into an error\n      if (error)\n        enqueued(new Error('Network error'));\n      else if (response.status >= 400)\n        enqueued(new Error(`Server returned status code ${response.status} from ${url}`));\n      else\n        response._consume().then((buffer)=> {\n          response.body = buffer;\n          enqueued(null, buffer);\n        });\n    });\n  }\n};\n"]}